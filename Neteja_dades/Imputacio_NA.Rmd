---
title: "Imputació de dades faltants"
author: "Arnau Gómez Català"
date: "2025-10-04"
output: pdf_document
---

```{r}
library(readr)
library(dplyr)
data <- read_csv("train.csv", col_types = cols(...1 = col_skip()))

for(i in 1:ncol(data)){
  if(is.character(data[[i]])==TRUE){
    data[[i]] = as.factor(data[[i]])
  }
}

data$HasCrCard <- as.factor(data$HasCrCard)
data$IsActiveMember <- as.factor(data$IsActiveMember)
data$SavingsAccountFlag <- as.factor(data$SavingsAccountFlag)
data$Exited <- as.factor(data$Exited)

```

Podrem veure els valors faltants de la nostra base de dades de forma visual:

```{r}
visdat::vis_dat(data)
```
Veiem només tenim dos tipus de variables (Factor i numèriques) però que tenim una barbaritat de NAs a les nostres variables. Anem a arreglar-ho.

# Imputació de valors faltants Univariants:

Mirarem primerament si hi han valors extrems que s'hagin de considerar NAs per haver estat incorrectament afegits a la base de dades:

```{r}
summary(data)
```
Busquem valors tant extrems que siguin irreals i s'hagin de considerar faltants; algú amb $500$ anys, una satifacció del client de $13$ cuan la variable es mou entre el $0$ i el $10$, ingresos negatius o variables binàries amb valors diferents a $1$ o $0$. Per aquesta base de dades no hem trobat valors d'aquest tipus, per tant començarem directament amb la imputació dels valors que ja tenim faltants.


Primerament comprovarem la aleatòrietat de les dades faltants amb el test de Little per a MCAR:

```{r}
naniar::mcar_test(data)
```
Comprovem que per un P-valor de `r naniar::mcar_test(data)$p.value` els nostres Missings are Completly generated At Random.


Podrem fer la primera imputació de les dades faltants a través de l'algorisme MICE (Multiple Imputation by Chained Equations):

```{r, results=FALSE, warning=FALSE, echo=TRUE, include=FALSE}
set.seed(28657)

complete_columns <- function(original, imputed) {
    out <- original
    for (col in names(imputed)) {
        out[col] <- imputed[col]
    }
    return(out)
}

#Imputació per a numeriques:

data_for_imputation_num <- data |>
  select(Tenure, Balance, TransactionFrequency, Age, NumOfProducts, ComplaintsCount, EstimatedSalary, AvgTransactionAmount, CreditScore, NetPromoterScore, DigitalEngagementScore)

mice_output_num <- mice::mice(data_for_imputation_num, method = "pmm", m = 10)
imputed_data_num <- mice::complete(mice_output_num)

data_imputed <- complete_columns(data, imputed_data_num)
```


```{r, results=FALSE, warning=FALSE, echo=TRUE, include=FALSE}
#Imputació per a categòriques:

data_for_imputation_fac <- data |>
  select(EducationLevel, LoanStatus, Geography, CustomerSegment, MaritalStatus)

mice_output_fac <- mice::mice(data_for_imputation_fac, method = "polyreg", m = 10)
imputed_data_fac <- mice::complete(mice_output_fac)

data_imputed <- complete_columns(data_imputed, imputed_data_fac)
```

```{r, results=FALSE, warning=FALSE, echo=TRUE, include=FALSE}
#Imputació per a binàries:

data_for_imputation_bin <- data |>
  select(Gender, HasCrCard, IsActiveMember, SavingsAccountFlag)

mice_output_bin <- mice::mice(data_for_imputation_bin, method = "logreg", m = 10)
imputed_data_bin <- mice::complete(mice_output_bin)

data_imputed <- complete_columns(data_imputed, imputed_data_bin)
```


```{r}
density_before_after <- function(before, after) {
    require(ggplot2)
    
    density_df_before <- before |> 
        select(where(is.numeric)) |>
        mutate(imputation = "original")
    
    density_df_after <- after |>
        select(where(is.numeric)) |>
        mutate(imputation = "imputat")
    
    density_df <- bind_rows(density_df_before, density_df_after) |>
        mutate(imputation = factor(imputation)) |>
        tidyr::pivot_longer(!imputation, names_to = "variable") |>
        filter(!is.na(value))
    
    ggplot(density_df, aes(x = value, color = imputation, fill = imputation)) +
        facet_wrap(~variable, scales = "free") +
        geom_histogram(alpha = 0.2, width = 0.1, bins = 30, position = "dodge") +
        scale_color_discrete(aesthetics = c("color", "fill"), name = "") +
        scale_y_continuous(breaks = NULL) +
        xlab("") +
        ylab("") +
        ggtitle("Densitat abans i després de la imputació.") +
        theme_minimal() +
        theme(panel.grid = element_blank())
}
mass_before_after <- function(before, after) {
    require(ggplot2)
    
    mass_df_before <- before |>
        select(where(is.factor)) |>
        mutate(imputation = "original")
    
    mass_df_after <- after |>
        select(where(is.factor)) |>
        mutate(imputation = "imputat")
    
    levels_in_order <- lapply(mass_df_before, levels) |> unlist()
    
    mass_df <- bind_rows(mass_df_before, mass_df_after) |>
        mutate(imputation = factor(imputation)) |>
        tidyr::pivot_longer(!imputation, names_to = "variable") |>
        filter(!is.na(value)) |>
        group_by(imputation, variable) |> 
        reframe(prop = proportions(table(value)), category = names(prop)) |>
        mutate(category = factor(category, levels = levels_in_order)) |>
        filter(prop > 0)
    
    ggplot(mass_df, aes(x = category, y = prop, color = imputation, fill = imputation)) +
        facet_wrap(~variable, scales = "free") +
        geom_col(alpha = 0.2, width = 0.6, position = "dodge") +
        scale_color_discrete(aesthetics = c("color", "fill"), name = "") +
        scale_y_continuous(breaks = NULL) +
        xlab("") +
        ylab("") +
        ggtitle("Massa abans i després de la imputació") + 
        theme_minimal() +
        theme(panel.grid = element_blank(),
              axis.text.x = element_text(angle = 45, hjust = 1))
}
```

```{r}
density_before_after(data, data_imputed)
```

```{r}
# mass_before_after(data, data_imputed)
```

















