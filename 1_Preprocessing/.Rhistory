#Imputació per a categòriques:
data_for_imputation_fac <- data |>
select(EducationLevel, LoanStatus, Geography, CustomerSegment, MaritalStatus)
mice_output_fac <- mice::mice(data_for_imputation_fac, method = "polyreg", m = 10)
imputed_data_fac <- mice::complete(mice_output_fac)
data_imputed <- complete_columns(data_imputed, imputed_data_fac)
#Imputació per a binàries:
data_for_imputation_bin <- data |>
select(Gender, HasCrCard, IsActiveMember, SavingsAccountFlag)
mice_output_bin <- mice::mice(data_for_imputation_bin, method = "logreg", m = 10)
imputed_data_bin <- mice::complete(mice_output_bin)
data_imputed <- complete_columns(data_imputed, imputed_data_bin)
density_before_after <- function(before, after) {
require(ggplot2)
density_df_before <- before |>
select(where(is.numeric)) |>
mutate(imputation = "original")
density_df_after <- after |>
select(where(is.numeric)) |>
mutate(imputation = "imputat")
density_df <- bind_rows(density_df_before, density_df_after) |>
mutate(imputation = factor(imputation)) |>
tidyr::pivot_longer(!imputation, names_to = "variable") |>
filter(!is.na(value))
ggplot(density_df, aes(x = value, color = imputation, fill = imputation)) +
facet_wrap(~variable, scales = "free") +
geom_histogram(alpha = 0.2, width = 0.1, bins = 30, position = "dodge") +
scale_color_discrete(aesthetics = c("color", "fill"), name = "") +
scale_y_continuous(breaks = NULL) +
xlab("") +
ylab("") +
ggtitle("Densitat abans i després de la imputació.") +
theme_minimal() +
theme(panel.grid = element_blank())
}
mass_before_after <- function(before, after) {
require(ggplot2)
mass_df_before <- before |>
select(where(is.factor)) |>
mutate(imputation = "original")
mass_df_after <- after |>
select(where(is.factor)) |>
mutate(imputation = "imputat")
levels_in_order <- lapply(mass_df_before, levels) |> unlist()
mass_df <- bind_rows(mass_df_before, mass_df_after) |>
mutate(imputation = factor(imputation)) |>
tidyr::pivot_longer(!imputation, names_to = "variable") |>
filter(!is.na(value)) |>
group_by(imputation, variable) |>
reframe(prop = proportions(table(value)), category = names(prop)) |>
mutate(category = factor(category, levels = levels_in_order)) |>
filter(prop > 0)
ggplot(mass_df, aes(x = category, y = prop, color = imputation, fill = imputation)) +
facet_wrap(~variable, scales = "free") +
geom_col(alpha = 0.2, width = 0.6, position = "dodge") +
scale_color_discrete(aesthetics = c("color", "fill"), name = "") +
scale_y_continuous(breaks = NULL) +
xlab("") +
ylab("") +
ggtitle("Massa abans i després de la imputació") +
theme_minimal() +
theme(panel.grid = element_blank(),
axis.text.x = element_text(angle = 45, hjust = 1))
}
density_before_after(data, data_imputed)
mass_before_after(data, data_imputed)
library(readr)
library(dplyr)
data <- read_csv("train.csv", col_types = cols(...1 = col_skip()))
for(i in 1:ncol(data)){
if(is.character(data[[i]])==TRUE){
data[[i]] = as.factor(data[[i]])
}
}
data$HasCrCard <- as.factor(data$HasCrCard)
data$IsActiveMember <- as.factor(data$IsActiveMember)
data$SavingsAccountFlag <- as.factor(data$SavingsAccountFlag)
data$Exited <- as.factor(data$Exited)
visdat::vis_dat(data)
summary(data)
naniar::mcar_test(data)
set.seed(28657)
complete_columns <- function(original, imputed) {
out <- original
for (col in names(imputed)) {
out[col] <- imputed[col]
}
return(out)
}
#Imputació per a numeriques:
data_for_imputation_num <- data |>
select(Tenure, Balance, TransactionFrequency, Age, NumOfProducts, ComplaintsCount, EstimatedSalary, AvgTransactionAmount, CreditScore, NetPromoterScore, DigitalEngagementScore)
mice_output_num <- mice::mice(data_for_imputation_num, method = "pmm", m = 10)
imputed_data_num <- mice::complete(mice_output_num)
data_imputed <- complete_columns(data, imputed_data_num)
#Imputació per a categòriques:
data_for_imputation_fac <- data |>
select(EducationLevel, LoanStatus, Geography, CustomerSegment, MaritalStatus)
mice_output_fac <- mice::mice(data_for_imputation_fac, method = "polyreg", m = 10)
imputed_data_fac <- mice::complete(mice_output_fac)
data_imputed <- complete_columns(data_imputed, imputed_data_fac)
#Imputació per a binàries:
data_for_imputation_bin <- data |>
select(Gender, HasCrCard, IsActiveMember, SavingsAccountFlag)
mice_output_bin <- mice::mice(data_for_imputation_bin, method = "logreg", m = 10)
imputed_data_bin <- mice::complete(mice_output_bin)
data_imputed <- complete_columns(data_imputed, imputed_data_bin)
density_before_after <- function(before, after) {
require(ggplot2)
density_df_before <- before |>
select(where(is.numeric)) |>
mutate(imputation = "original")
density_df_after <- after |>
select(where(is.numeric)) |>
mutate(imputation = "imputat")
density_df <- bind_rows(density_df_before, density_df_after) |>
mutate(imputation = factor(imputation)) |>
tidyr::pivot_longer(!imputation, names_to = "variable") |>
filter(!is.na(value))
ggplot(density_df, aes(x = value, color = imputation, fill = imputation)) +
facet_wrap(~variable, scales = "free") +
geom_histogram(alpha = 0.2, width = 0.1, bins = 30, position = "dodge") +
scale_color_discrete(aesthetics = c("color", "fill"), name = "") +
scale_y_continuous(breaks = NULL) +
xlab("") +
ylab("") +
ggtitle("Densitat abans i després de la imputació.") +
theme_minimal() +
theme(panel.grid = element_blank())
}
mass_before_after <- function(before, after) {
require(ggplot2)
mass_df_before <- before |>
select(where(is.factor)) |>
mutate(imputation = "original")
mass_df_after <- after |>
select(where(is.factor)) |>
mutate(imputation = "imputat")
levels_in_order <- lapply(mass_df_before, levels) |> unlist()
mass_df <- bind_rows(mass_df_before, mass_df_after) |>
mutate(imputation = factor(imputation)) |>
tidyr::pivot_longer(!imputation, names_to = "variable") |>
filter(!is.na(value)) |>
group_by(imputation, variable) |>
reframe(prop = proportions(table(value)), category = names(prop)) |>
group_by(variable) |>
mutate(category = factor(category, levels = levels(mass_df_before[[unique(variable)]]))) |>
filter(prop > 0)
ggplot(mass_df, aes(x = category, y = prop, color = imputation, fill = imputation)) +
facet_wrap(~variable, scales = "free") +
geom_col(alpha = 0.2, width = 0.6, position = "dodge") +
scale_color_discrete(aesthetics = c("color", "fill"), name = "") +
scale_y_continuous(breaks = NULL) +
xlab("") +
ylab("") +
ggtitle("Massa abans i després de la imputació") +
theme_minimal() +
theme(panel.grid = element_blank(),
axis.text.x = element_text(angle = 45, hjust = 1))
}
density_before_after(data, data_imputed)
mass_df_before <- data |>
select(where(is.factor)) |>
select(!c(Surname)) |>
mutate(imputation = "original")
mass_df_after <- data_imputed |>
select(where(is.factor)) |>
select(!c(Surname)) |>
mutate(imputation = "imputat")
levels_in_order <- lapply(mass_df_before, levels) |> unlist()
mass_df <- bind_rows(mass_df_before, mass_df_after) |>
mutate(imputation = factor(imputation)) |>
tidyr::pivot_longer(!imputation, names_to = "variable") |>
filter(!is.na(value)) |>
group_by(imputation, variable) |>
reframe(prop = proportions(table(value)), category = names(prop)) |>
group_by(variable) |>
mutate(category = factor(category, levels = levels(mass_df_before[[unique(variable)]]))) |>
filter(prop > 0)
ggplot(mass_df, aes(x = category, y = prop, color = imputation, fill = imputation)) +
facet_wrap(~variable, scales = "free") +
geom_col(alpha = 0.2, width = 0.6, position = "dodge") +
scale_color_discrete(aesthetics = c("color", "fill"), name = "") +
scale_y_continuous(breaks = NULL) +
xlab("") +
ylab("") +
ggtitle("Massa abans i després de la imputació") +
theme_minimal() +
theme(panel.grid = element_blank(),
axis.text.x = element_text(angle = 45, hjust = 1))
mass_before_after(data, data_imputed)
mass_before_after(data, data_imputed)
library(readr)
library(dplyr)
data <- read_csv("train.csv", col_types = cols(...1 = col_skip()))
for(i in 1:ncol(data)){
if(is.character(data[[i]])==TRUE){
data[[i]] = as.factor(data[[i]])
}
}
data$HasCrCard <- as.factor(data$HasCrCard)
data$IsActiveMember <- as.factor(data$IsActiveMember)
data$SavingsAccountFlag <- as.factor(data$SavingsAccountFlag)
data$Exited <- as.factor(data$Exited)
visdat::vis_dat(data)
summary(data)
naniar::mcar_test(data)
set.seed(28657)
complete_columns <- function(original, imputed) {
out <- original
for (col in names(imputed)) {
out[col] <- imputed[col]
}
return(out)
}
#Imputació per a numeriques:
data_for_imputation_num <- data |>
select(Tenure, Balance, TransactionFrequency, Age, NumOfProducts, ComplaintsCount, EstimatedSalary, AvgTransactionAmount, CreditScore, NetPromoterScore, DigitalEngagementScore)
mice_output_num <- mice::mice(data_for_imputation_num, method = "pmm", m = 10)
imputed_data_num <- mice::complete(mice_output_num)
data_imputed_MICE <- complete_columns(data, imputed_data_num)
#Imputació per a categòriques:
data_for_imputation_fac <- data |>
select(EducationLevel, LoanStatus, Geography, CustomerSegment, MaritalStatus)
mice_output_fac <- mice::mice(data_for_imputation_fac, method = "polyreg", m = 10)
imputed_data_fac <- mice::complete(mice_output_fac)
data_imputed_MICE <- complete_columns(data_imputed_MICE, imputed_data_fac)
#Imputació per a binàries:
data_for_imputation_bin <- data |>
select(Gender, HasCrCard, IsActiveMember, SavingsAccountFlag)
mice_output_bin <- mice::mice(data_for_imputation_bin, method = "logreg", m = 10)
imputed_data_bin <- mice::complete(mice_output_bin)
data_imputed_MICE <- complete_columns(data_imputed_MICE, imputed_data_bin)
density_before_after <- function(before, after) {
require(ggplot2)
density_df_before <- before |>
select(where(is.numeric)) |>
mutate(imputation = "original")
density_df_after <- after |>
select(where(is.numeric)) |>
mutate(imputation = "imputat")
density_df <- bind_rows(density_df_before, density_df_after) |>
mutate(imputation = factor(imputation)) |>
tidyr::pivot_longer(!imputation, names_to = "variable") |>
filter(!is.na(value))
ggplot(density_df, aes(x = value, color = imputation, fill = imputation)) +
facet_wrap(~variable, scales = "free") +
geom_histogram(alpha = 0.2, width = 0.1, bins = 30, position = "dodge") +
scale_color_discrete(aesthetics = c("color", "fill"), name = "") +
scale_y_continuous(breaks = NULL) +
xlab("") +
ylab("") +
ggtitle("Densitat abans i després de la imputació.") +
theme_minimal() +
theme(panel.grid = element_blank())
}
mass_before_after <- function(before, after) {
require(ggplot2)
mass_df_before <- before |>
select(where(is.factor)) |>
mutate(imputation = "original")
mass_df_after <- after |>
select(where(is.factor)) |>
mutate(imputation = "imputat")
levels_in_order <- lapply(mass_df_before, levels) |> unlist()
mass_df <- bind_rows(mass_df_before, mass_df_after) |>
mutate(imputation = factor(imputation)) |>
tidyr::pivot_longer(!imputation, names_to = "variable") |>
filter(!is.na(value)) |>
group_by(imputation, variable) |>
reframe(prop = proportions(table(value)), category = names(prop)) |>
group_by(variable) |>
mutate(category = factor(category, levels = levels(mass_df_before[[unique(variable)]]))) |>
filter(prop > 0)
ggplot(mass_df, aes(x = category, y = prop, color = imputation, fill = imputation)) +
facet_wrap(~variable, scales = "free") +
geom_col(alpha = 0.2, width = 0.6, position = "dodge") +
scale_color_discrete(aesthetics = c("color", "fill"), name = "") +
scale_y_continuous(breaks = NULL) +
xlab("") +
ylab("") +
ggtitle("Massa abans i després de la imputació") +
theme_minimal() +
theme(panel.grid = element_blank(),
axis.text.x = element_text(angle = 45, hjust = 1))
}
density_before_after(data, data_imputed_MICE)
data_for_imputation <- cbind(data_for_imputation_bin, data_for_imputation_fac, data_for_imputation_num)
View(data_for_imputation)
data_for_imputation <- cbind(data_for_imputation_bin, data_for_imputation_fac, data_for_imputation_num)
set.seed(28657)
imputed_data <- DMwR2::knnImputation(
as.data.frame(data_for_imputation),
k = 7,
meth = "median"
)
data_for_imputation <- cbind(data_for_imputation_bin, data_for_imputation_fac, data_for_imputation_num) |>
select(!c(Surname))
View(data_for_imputation)
data_for_imputation <- cbind(data_for_imputation_bin, data_for_imputation_fac, data_for_imputation_num)
set.seed(28657)
imputed_data <- VIM::kNN(
as.data.frame(data_for_imputation),
k = 7, imp_var = FALSE)
data_imputed_KNN <- complete_columns(data_for_imputation, imputed_data)
View(data_imputed_KNN)
density_before_after(data, data_imputed_KNN)
mass_before_after(data, data_imputed_KNN)
set.seed(28657)
forest_output <- missForest::missForest(
as.data.frame(data_for_imputation),
maxiter = 4, ntree = 10,
variablewise = TRUE, verbose = TRUE,
)
data_imputed_FOREST <- complete_columns(data, forest_output$ximp)
summary(data_for_imputation)
bind_cols(
variable = names(forest_output$ximp),
tipus_error = names(forest_output$OOBerror),
error = round(forest_output$OOBerror, 2)
) |>
arrange(tipus_error, -error) |>
knitr::kable(col.names = c("Variable", "Tipus d'Error", "Error"))
forest_output
density_before_after(data, data_imputed_FOREST)
mass_before_after(data, data_imputed_FOREST)
set.seed(28657)
forest_output <- missForest::missForest(
as.data.frame(data_for_imputation),
maxiter = 10, ntree = 20,
variablewise = TRUE, verbose = TRUE,
)
data_imputed_FOREST <- complete_columns(data, forest_output$ximp)
set.seed(28657)
forest_output <- missForest::missForest(
as.data.frame(data_for_imputation),
maxiter = 10, ntree = 20,
variablewise = TRUE, verbose = TRUE,
)
data_imputed_FOREST <- complete_columns(data, forest_output$ximp)
summary(data_for_imputation)
set.seed(28657
)
areg_output <- Hmisc::aregImpute(
data = data_for_imputation,
formula = ~ Gender + HasCrCard + IsActiveMember + SavingsAccountFlag + EducationLevel + LoanStatus + Geography + CustomerSegment + MaritalStatus + Tenure + Balance + TransactionFrequency + Age + NumOfProducts + ComplaintsCount + EstimatedSalary + AvgTransactionAmount + CreditScore + NetPromoterScore + DigitalEngagementScore ,
nk = 5
)
set.seed(28657)
areg_output <- Hmisc::aregImpute(
data = data_for_imputation,
formula = ~ Gender + HasCrCard + IsActiveMember + SavingsAccountFlag + EducationLevel + LoanStatus + Geography + CustomerSegment + MaritalStatus + Tenure + Balance + TransactionFrequency + Age + EstimatedSalary + AvgTransactionAmount + CreditScore + NetPromoterScore + DigitalEngagementScore ,
nk = 5
)
set.seed(28657)
areg_output <- Hmisc::aregImpute(
data = data_for_imputation,
formula = ~ Gender + HasCrCard + IsActiveMember + SavingsAccountFlag + EducationLevel + LoanStatus + Geography + CustomerSegment + MaritalStatus + Tenure + Balance + TransactionFrequency + Age + NumOfProducts + EstimatedSalary + AvgTransactionAmount + CreditScore + NetPromoterScore + DigitalEngagementScore ,
nk = 5
)
set.seed(28657)
areg_output <- Hmisc::aregImpute(
data = data_for_imputation,
formula = ~ Gender + HasCrCard + IsActiveMember + SavingsAccountFlag + EducationLevel + LoanStatus + Geography + CustomerSegment + MaritalStatus + Tenure + Balance + TransactionFrequency + Age + EstimatedSalary + AvgTransactionAmount + CreditScore + NetPromoterScore + DigitalEngagementScore ,
nk = 5
)
imputed_data_BOOT <- areg_output$imputed
View(imputed_data_BOOT)
imputed_data_BOOT <- areg_output$imputed
data_imputed_areg <- data
for (col in names(imputed_data)) {
airbnb_imputed_areg [[col]] [is.na(data[[col]])] <-
imputed_data_BOOT[[col]][, 5L]
}
imputed_data_BOOT <- areg_output$imputed
data_imputed_areg <- data
for (col in names(imputed_data_BOOT)) {
data_imputed_areg [[col]] [is.na(data[[col]])] <-
imputed_data_BOOT[[col]][, 5L]
}
View(imputed_data_BOOT)
mass_before_after(data, imputed_data_BOOT)
areg_output
data_imputed_BOOT <- complete_columns(data, areg_output$imputed)
imputed_data_BOOT <- areg_output$imputed
data_imputed_areg <- data
for (col in names(imputed_data_BOOT)) {
data_imputed_areg [[col]] [is.na(data[[col]])] <-
imputed_data_BOOT[[col]][, 5L]
}
View(data_imputed_areg)
imputed_data_BOOT <- areg_output$imputed
data_imputed_areg <- data
for (col in names(imputed_data_BOOT)) {
if (is.factor(data[[col]])) {
# Convertir los números internos a niveles
levels_col <- levels(data[[col]])
data_imputed_areg[[col]][is.na(data[[col]])] <-
factor(levels_col[ imputed_data_BOOT[[col]][, 5L] ], levels = levels_col)
} else {
# Numéricas
data_imputed_areg[[col]][is.na(data[[col]])] <- imputed_data_BOOT[[col]][, 5L]
}
}
View(imputed_data_bin)
View(imputed_data_BOOT)
View(data_imputed_areg)
imputed_data_BOOT <- areg_output$imputed
data_imputed_AREG <- data
for (col in names(imputed_data_BOOT)) {
if (is.factor(data[[col]])) {
levels_col <- levels(data[[col]])
data_imputed_AREG[[col]][is.na(data[[col]])] <-
factor(levels_col[ imputed_data_BOOT[[col]][, 5L] ], levels = levels_col)
} else {
data_imputed_AREG[[col]][is.na(data[[col]])] <- imputed_data_BOOT[[col]][, 5L]
}
}
mass_before_after(data, data_imputed_AREG)
density_before_after(data, data_imputed_AREG)
density_before_after(data, data_imputed_AREG)
load("C:/Users/mdrhu/Treball_Mineria_de_Dades/0_Bases_de_dades/Imputed/data_NA_imputed_AREG_test.RData")
load("C:/Users/mdrhu/Treball_Mineria_de_Dades/0_Bases_de_dades/Outliers/dataAREG_outliers.RData")
library(caret)
library(naivebayes)
library(smotefamily)
# F1
f1 <- function(data, lev = NULL, model = NULL) {
f1_val <- MLmetrics::F1_Score(y_pred = data$pred, y_true = data$obs, positive = "Yes")
c(F1 = f1_val)
}
control <- trainControl(
method = "repeatedcv",
number = 5,
repeats = 3,
classProbs = TRUE,
summaryFunction = f1,
#sampling = "smote",
verboseIter = TRUE
)
# Grid inicial
grid <- expand.grid(
usekernel = c(TRUE, FALSE),
laplace = c(0, 0.5, 1),
adjust = c(0, 0.5, 1, 1.5)
)
# Entrenamiento inicial
modelo_nb <- train(
Exited ~ .,
data = dataTrain,
method = "naive_bayes",
trControl = control,
tuneGrid = grid,
metric = "F1"
)
Index <- sample(1:nrow(data), size = nrow(data)*0.8)
dataTrain <- data[Index, ]
dataTest  <- data[-Index, ]
dataTrain$Exited <- factor(dataTrain$Exited, levels = c(0,1), labels = c("No", "Yes"))
set.seed(123)
data <- dataAREG
Index <- sample(1:nrow(data), size = nrow(data)*0.8)
dataTrain <- data[Index, ]
dataTest  <- data[-Index, ]
dataTrain$Exited <- factor(dataTrain$Exited, levels = c(0,1), labels = c("No", "Yes"))
dataTest$Exited  <- factor(dataTest$Exited,  levels = c(0,1), labels = c("No", "Yes"))
# F1
f1 <- function(data, lev = NULL, model = NULL) {
f1_val <- MLmetrics::F1_Score(y_pred = data$pred, y_true = data$obs, positive = "Yes")
c(F1 = f1_val)
}
control <- trainControl(
method = "repeatedcv",
number = 5,
repeats = 3,
classProbs = TRUE,
summaryFunction = f1,
#sampling = "smote",
verboseIter = TRUE
)
# Grid inicial
grid <- expand.grid(
usekernel = c(TRUE, FALSE),
laplace = c(0, 0.5, 1),
adjust = c(0, 0.5, 1, 1.5)
)
# Ajuste fino
grid2 <- expand.grid(
usekernel = FALSE,
laplace = 0,
adjust = c(0,0.5,1,2,3,4,5)
)
modelo_nb2 <- train(
Exited ~ .,
data = dataTrain,
method = "naive_bayes",
trControl = control,
tuneGrid = grid2,
metric = "F1"
)
print(modelo_nb2)
# Predicciones (selecciona automaticamente los mejores parametros)
pred_class <- predict(modelo_nb2, newdata = dataTest, type = "raw")
pred_prob  <- predict(modelo_nb2, newdata = dataTest, type = "prob")
cm <- confusionMatrix(pred_class, dataTest$Exited, positive = "Yes")
print(cm)
pred_test <- predict(modelo_nb2, newdata = data_imputed_AREG_test, type = "raw")
submission <- data.frame(
ID = data_imputed_AREG_test$ID,
Exited = pred_test
)
write.csv(submission, "submission_nb_nosmote.csv", row.names = FALSE)
